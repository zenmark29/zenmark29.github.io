<html>

<head>
    <title>Relax in your breath</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .button {
            background-color: #4CAF50;
            /* Green */
            border: none;
            color: white;
            padding: 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            align-items: center;
        }

        .button5 {
            border-radius: 50%;
        }
        
        html,
        body {
        margin:0;
        padding:0;
        height:100%;
        }
        #container {
        min-height:100%;
        position:relative;
        }
        #header {
        
        padding:10px;
        }
        #body {
        padding:10px;
        
            text-align: center;
            text-decoration: none;
           /* display: inline-block;*/
            font-size: 16px;
            /*margin: 4px 2px;*/
            cursor: pointer;
            align-items: center;
            
        padding-bottom:60px;   /* Height of the footer */
        }
        #footer {
        position:absolute;
        bottom:0;
        width:100%;
        height:60px;   /* Height of the footer */
        
        }
    </style>
     <script src="js/date.js"></script>
    <script>
        var x;
        var startMinutes;
        var holdMinutes;
        var initial_volume;

        function pause() {
            clearTimeout(x);
            holdMinutes += 1;
            document.getElementById("timer_display").innerHTML = "stopped...";
            document.getElementById('messages').innerHTML = '';
            document.getElementById("start_button").style = "display: block";
            document.getElementById("stop_button").style = "display: none";

        }

        function fadeVolume(audio, callback) {
            var factor = 0.01,
                speed = 100;
            if (audio.volume > factor) {
                setTimeout(function () {
                    audio.volume -= factor;
                    fadeVolume(audio, callback);
                }, speed);
            } else {
                (typeof (callback) !== 'function') || callback();
            }
        }

        function updateCompletedMeditationTime(){
            try {
               
                console.log("minutes completed = " + startMinutes);
                
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("totalMeditationMinutes", Number(localStorage.getItem("totalMeditationMinutes"))  + Number(startMinutes));
                    lastDate = localStorage.getItem('LAST_DATE') ? localStorage.getItem('LAST_DATE') : new Date();
                    lastDate = (lastDate instanceof Date) ? lastDate : new Date();
                    lastStreak = localStorage.getItem("STREAK") ? localStorage.getItem("STREAK") : 1;
                    
                    var results = calculateStreak(lastDate, lastStreak);
                    console.log(results[0] + " " + results[1]);
                    localStorage.setItem('LAST_DATE', results[0]);
                    localStorage.setItem('STREAK',results[1]);
                } else {
                    console.log("no support for localstorage");
                }
                
            } catch (err) {
                console.log('error storing completed minutes.:' + err);
            }
        }
    
        function meditate() { 
            document.getElementById("streak").innerHTML = "";
            var bowl_sound = document.getElementById("bowl");
            initial_volume = bowl_sound.volume;
            bowl_sound.play();

            fadeVolume(bowl_sound, function () { console.log('fade complete'); });
            document.getElementById("start_button").style = "display: none";
            document.getElementById("stop_button").style = "display: block";
            var messageElement = document.getElementById('messages');
            var messageId = 0;
            //var startMinutes;
            try {
                startMinutes = document.getElementById('minutes').value;
                if (startMinutes === '') {
                    startMinutes = 5;
                }
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("minutes", startMinutes);
                } else {
                    console.log("no support for localstorage");
                }
            } catch (err) {
                startMinutes = holdMinutes;
            }

            holdMinutes = startMinutes;
            // Set the date we're counting down to
            var countDownDate = new Date();
            var holdSeconds = 0;
            var opacity = 0;
            var opacityChangeConstant = .03;

            countDownDate.setTime(countDownDate.getTime() + startMinutes * 60 * 1000);
            var countDownDate = countDownDate.getTime();

            // Update the count down every 1 second
            x = setInterval(function () {

                // Get todays date and time
                var now = new Date().getTime();

                // Find the distance between now an the count down date
                var distance = countDownDate - now;

                // Time calculations for days, hours, minutes and seconds
                var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                // Display the result in the element with id="timer_display"
                document.getElementById("timer_display").innerHTML = minutes + ":" + seconds;
                if (seconds !== holdSeconds) {
                    //console.log("seconds = " + seconds);
                    holdSeconds = seconds;
                    if (seconds < 30) {
                        opacity -= opacityChangeConstant;
                        if (opacity <= 0) {
                            opacity = 0;
                        }
                        messageElement.style.opacity = opacity;

                    } else {
                        opacity += opacityChangeConstant;
                        if (opacity > 1) {
                            opacity = 1;
                        }
                        messageElement.style.opacity = opacity;
                    }
                }
                if (holdMinutes !== minutes) {
                    holdMinutes = minutes;
                    messageElement.innerHTML = messages[messageId];
                    messageId++;
                    if (messageId >= messages.length) {
                        messageId = 0;
                    }
                }
                // If the count down is finished, write some text 
                if (distance < 0) {
                    clearInterval(x);
                    messageElement.innerHTML = '';
                    document.getElementById("stop_button").style = "display: none";
                    console.log("update should happen here.");
                    updateCompletedMeditationTime();
                    document.getElementById("timer_display").innerHTML =
                        "Your meditation is complete.<br> Your total mediation = " + localStorage.getItem("totalMeditationMinutes") + " minutes.";
                    var lastStreak = localStorage.getItem("STREAK") ? localStorage.getItem("STREAK") : 0;
                    document.getElementById("streak").innerHTML = "You have a " + lastStreak + " day streak.";    
                    var bowl_sound = document.getElementById("bowl");
                    bowl_sound.volume = initial_volume;
                    bowl_sound.play();
                    fadeVolume(bowl_sound, function () { console.log('fade complete'); });

                }
            }, 1000);
        }
    </script>

    <script>


        function recallLastMeditation() {
            if (typeof (Storage) !== "undefined") {
                if (localStorage.getItem("minutes")) {
                    document.getElementById('minutes').value = localStorage.getItem("minutes");
                } else {
                    document.getElementById("minutes").value = 5;
                }
                var lastStreak = localStorage.getItem("STREAK") ? localStorage.getItem("STREAK") : 0;
                document.getElementById("streak").innerHTML = "You have a " + lastStreak + " day streak.";
            } else {
                document.getElementById("minutes").value = 5;
            }

        }
    </script>

    <script>
        var messages = ["Sit straight, but relaxed...", "Let your body relax...", "Focus on the breath...",
            "Simply observe the flow of thoughts, while staying aware...", "This moment, just being is enough...",
            "It is OK to take care of yourself...", "self care is good care..."
        ];
    </script>
</head>

<body onload="recallLastMeditation();">
    <div id="container">
        <div id="header">



            <div id="meditate" align="center">
                <button id="start_button" onclick="meditate()" class="button button5" style="display: block;">meditate</button>
            </div>
            <div id="pause" align="center">
                <button id="stop_button" onclick="pause()" class="button button5" style="display: none">pause</button>
            </div>
        </div>
        <div id="body">
            <div id="timer_display" align="center">
                <input id="minutes" type="number" min="1" max="60" value="5" item-width="2"> minutes</div>
            <div id="your_streak" align="center"></div>
            <div id="messages" align="center">Welcome to your meditation...</div>
            <div id="streak" align="center"></div>
            <div id="audio_controls" align="center">
                <audio id="bowl">
                    <source src="Meditation_Bowl.flac" type="audio/wav">
                </audio>
            </div>
        </div>
        <div align="center">
            <footer id='footer'>version 0.4</footer>
        </div>
    </div>
</body>

</html>